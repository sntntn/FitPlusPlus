version: "3.9"

services:
  # === Databases ===
  analyticsdb:
    image: mongo

  chatdb:
    image: mongo

  clientdb:
    image: mongo

  notificationdb:
    image: mongo

  nutritiondb:
    image: mongo

  paymentdb:
    image: mongo

  reservationdb:
    image: mongo

  reviewdb:
    image: mongo

  trainerdb:
    image: mongo

  videotrainingdb:
    image: mongo

  # === Infrastructure ===
  consul:
    image: consul:1.15.4

  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest

  rabbitmq:
    image: rabbitmq:3-management-alpine

  # === Gateway ===
  gatewayservice.api:
    image: ${DOCKER_REGISTRY-}gatewayserviceapi
    build:
      context: .
      dockerfile: Services/GatewayService/GatewayService.API/Dockerfile
    depends_on:
      - consul

  # === Trainer Service ===
  trainerservice.api:
    image: ${DOCKER_REGISTRY-}trainerserviceapi
    build:
      context: .
      dockerfile: Services/TrainerService/TrainerService.API/Dockerfile
    depends_on:
      - trainerdb
      - reviewservice.grpc
      - consul

  trainerservice.grpc:
    image: ${DOCKER_REGISTRY-}trainerservicegrpc
    build:
      context: .
      dockerfile: Services/TrainerService/TrainerService.GRPC/Dockerfile
    depends_on:
      - trainerdb

  # === Client Service ===
  clientservice.api:
    image: ${DOCKER_REGISTRY-}clientserviceapi
    build:
      context: .
      dockerfile: Services/ClientService/ClientService.API/Dockerfile
    depends_on:
      - clientdb
      - consul

  clientservice.grpc:
    image: ${DOCKER_REGISTRY-}clientservicegrpc
    build:
      context: .
      dockerfile: Services/ClientService/ClientService.GRPC/Dockerfile
    depends_on:
      - clientdb
      - consul

  # === Identity Service ===
  identityserver:
    image: ${DOCKER_REGISTRY-}identityserver
    build:
      context: .
      dockerfile: Security/IdentityServer/Dockerfile
    depends_on:
      - consul
      - mssql

  # === Review Service ===
  reviewservice.api:
    image: ${DOCKER_REGISTRY-}reviewserviceapi
    build:
      context: .
      dockerfile: Services/ReviewService/ReviewService.API/Dockerfile
    depends_on:
      - reviewdb
      - rabbitmq
      - consul

  reviewservice.grpc:
    image: ${DOCKER_REGISTRY-}reviewservicegrpc
    build:
      context: .
      dockerfile: Services/ReviewService/ReviewService.GRPC/Dockerfile
    depends_on:
      - reviewdb
      - consul

  # === Payment Service ===
  paymentservice.api:
    image: ${DOCKER_REGISTRY-}paymentserviceapi
    build:
      context: .
      dockerfile: Services/PaymentService/PaymentService.API/Dockerfile
    depends_on:
      - consul

  # === Reservation Service ===
  reservationservice.api:
    image: ${DOCKER_REGISTRY-}reservationserviceapi
    build:
      context: .
      dockerfile: Services/ReservationService/ReservationService.API/Dockerfile
    depends_on:
      - paymentdb
      - consul
      - rabbitmq

  # === Analytics Service ===
  analyticsservice.api:
    image: ${DOCKER_REGISTRY-}analyticsserviceapi
    build:
      context: .
      dockerfile: Services/AnalyticsService/AnalyticsService.API/Dockerfile
    depends_on:
      - analyticsdb
      - consul
      - rabbitmq

  # === Notification Service ===
  notificationservice.api:
    image: ${DOCKER_REGISTRY-}notificationserviceapi
    build:
      context: .
      dockerfile: Services/NotificationService/NotificationService.API/Dockerfile
    depends_on:
      - consul
      - notificationdb
      - rabbitmq

  # === Chat Service ===
  chatservice.api:
    image: ${DOCKER_REGISTRY-}chatserviceapi
    build:
      context: .
      dockerfile: Services/ChatService/ChatService.API/Dockerfile
    depends_on:
      - chatdb
      - rabbitmq
      - consul

  # === Nutrition Service ===
  nutritionservice.api:
    image: ${DOCKER_REGISTRY-}nutritionserviceapi
    build:
      context: .
      dockerfile: Services/NutritionService/NutritionService.API/Dockerfile
    depends_on:
      - nutritiondb
      - consul

  # === Video Training Service ===
  videotrainingservice.api:
    image: ${DOCKER_REGISTRY-}videotrainingserviceapi
    build:
      context: .
      dockerfile: Services/videoTrainingService/videoTrainingService.API/Dockerfile
    depends_on:
      - videotrainingdb
      - consul
    volumes:
      - ./uploads:/app/uploads

volumes:
  analyticsmongo_data:
  chatmongo_data:
  clientmongo_data:
  consul_data:
  mssql_data:
  mssql_volume:
  notificationmongo_data:
  nutritionmongo_data:
  paymentmongo_data:
  reservationmongo_data:
  reviewmongo_data:
  trainermongo_data:
  videotrainingmongo_data: